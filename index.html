<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <title>Scott Schubert - JWT Auth</title>

    <meta
      name="description"
      content="Presentation on JWT Authentication for Single Page Applications"
    />
    <meta name="author" content="Scott Schubert" />

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="dist/reset.css" />
    <link rel="stylesheet" href="dist/reveal.css" />
    <link rel="stylesheet" href="dist/theme/black.css" />

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css" />
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section>Securing a dotnet core API with a JWT</section>

        <section>
          <section>
            <h2>Authentication vs Authorization</h2>
          </section>
          <section>
            <table class="table">
              <thead>
                <tr>
                  <th><strong>Authentication</strong></th>
                  <th><strong>Authorization</strong></th>
                </tr>
              </thead>
              <tbody>
                <tr class="fragment fade-up">
                  <td>Determines whether users are who they claim to be</td>
                  <td>Determines what users can and cannot access</td>
                </tr>
                <tr class="fragment fade-up">
                  <td>
                    Challenges the user to validate credentials (for example,
                    through passwords)
                  </td>

                  <td>
                    Verifies whether access is allowed through policies and
                    rules
                  </td>
                </tr>
                <tr class="fragment fade-up">
                  <td>Usually done before authorization</td>
                  <td>Usually done after successful authentication</td>
                </tr>
              </tbody>
            </table>
            <small class="fragment">
              <a
                href="https://auth0.com/docs/get-started/identity-fundamentals/authentication-and-authorization"
                >source (Auth0)</a
              >
            </small>
          </section>
        </section>

        <section>
          <section>
            <h2>What is a JWT?</h2>
            <p class="fragment fade-up">
              A JWT is the acronym for JSON Web Token. A JWT can look something
              like this.
            </p>
            <pre>
				<code data-line-numbers="2,3|4,5|6,7|2-7">
					// The header
					eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.
					// The payload
					eyJpZCI6IjMiLCJuYmYiOjE2NTQyNjI1MzgsImV4cCI6MTY1NDI2MjU5OCwiaWF0IjoxNjU0MjYyNTM4fQ.
					// The signature
					fNcXKNiYCu5AI22vIjyBEnRAiYitrHhjdB9MnNpZGCk
				</code>
			</pre>
          </section>
          <section>
            <h2>What can be stored in a JWT?</h2>
            <p class="fragment">
              Pretty much anything! However, JWT's can be read by anyone, so
              keep the information non-personal.
            </p>
            <img class="fragment fade-up" data-src="./media/jwt-example.png" />
          </section>
          <section>
            <h2>If they can be read by anyone, how are they secure?</h2>
            <p class="fragment">
              The secret signature is what will keep your resources (e.g. API)
              secure!
            </p>
          </section>
        </section>

        <section>
          <section>How can a JWT be used to secure an API?</section>
          <section>
            <h2>Flow diagram of the process</h2>
            <img class="fragment fade-up" data-src="./media/auth-flow.webp" />
          </section>
        </section>

        <section>
          <section>
            <h2>Register process</h2>            
          </section>
		  <section>
			  <h2>End point in controller for registration</h2>
			  <pre><code data-trim data-noescape data-line-numbers="1-3|5-9|10-13">
[HttpPost]
[Route("register")]
public async Task<IActionResult> Register(RegisterRequest userForRegister)
{
	try
	{
		await _userService.Register(userForRegister, Role.User);
		return Ok(new { message = "Registration successful" });
	}
	catch (System.Exception ex)
	{
		return Conflict(ex.Message);
	}
}
			  </code></pre>
		  </section>
		  <section>
			  <h2>Registering a user request</h2>
			  <img data-src="./media/register/register-swagger.png" />
		  </section>
		  <section>
			  <h2>Registering a user response</h2>
			  <img data-src="./media/register/register-response.png" />
		  </section>
        </section>

        <section>
          <section>
			  <h2>Authorised routes</h2>
			  <p>Authorised routes require an authenticated user in order to be accessed.</p>
          </section>
          <section data-markdown>
            <textarea data-template>
				  ## Two endpoints, one unprotected, one protected
				  ```c# [1-3|10-13]
				  [HttpGet]
				  [AllowAnonymous]
				  public async Task<IActionResult> Index()
				  {
					  return Ok(await _userService.GetAllAsync());
				  }
		  
				  [HttpGet]
				  [Authorize]
				  [Route("{id}", Name = "GetUserById")]
				  public async Task<IActionResult> GetUserById(int id)
				  {
					  var user = await _userService.GetByIdAsync(id);
		  
					  if (user == null)
					  {
						  return NotFound();
					  }
		  
					  return Ok(user);
				  }
				  ```
			  </textarea
            >
          </section>
		  <section>
			  <h2>The unprotected route in action</h2>
			  <img data-src="./media/end-points/getallusers.png" />
		  </section>
		  <section>
			  <h2>The protected route</h2>
			<pre><code data-noescape data-trim data-line-numbers="1-4">
[HttpGet]
[Authorize]
[Route("{id}", Name = "GetUserById")]
public async Task<IActionResult> GetUserById(int id)
{
	var user = await _userService.GetByIdAsync(id);

	if (user == null)
	{
		return NotFound();
	}

	return Ok(user);
}
			</code></pre>
		  </section>
		  <section>
			  <h2>The protected route in action</h2>
			  <img data-src="./media/end-points/get-user-request.png" />
			  <img data-src="./media/end-points/get-user-response.png" />
		  </section>
		  <section>
			  <h2>Time to login</h2>
			  <p>Logging in will generate a JWT and allow us to provide it with requests.</p>
			  <p>The API will verify the JWT and then provide access to the resources.</p>
		  </section>
        </section>

		<section>
			<section>
				<h2>The login process</h2>
				<p>Using the authenticate endpoint, we provide email and password as the AuthenticateRequest.</p>
				<img data-src="./media/login-request.png" />	
			</section>
			<section>
				<pre>
					<code data-noescape data-trim data-line-numbers="1-3|8-10">
[AllowAnonymous]
[HttpPost("authenticate")]
public async Task<IActionResult> Authenticate(AuthenticateRequest model)
{

	try
	{
		var authResponse = await _userService.Authenticate(model, ipAddress());
		setTokenCookie(authResponse.RefreshToken);
		return Ok(authResponse);

	}
	catch (AppException ex)
	{
		return Unauthorized(ex);
	}
}
					</code>
				</pre>				
			</section>
			<section>
				<h2>Check the auth details in the User Service</h2>
				<p>Try and find the user by email, then check the password matches that in the database</p>
				<pre>
					<code data-noescape data-trim data-line-numbers="1-2|4-7">
var user = await _context.Users
	.SingleOrDefaultAsync(x => x.Email == model.Email);

// validate
if (user == null 
	|| !BCrypt.Net.BCrypt.Verify(model.Password, user.PasswordHash))
	throw new AppException("Username or password is incorrect");
					</code>
				</pre>
			</section>
			<section>
				<h2>If the user exists and password is correct, it's time to create the JWT!</h2>
			</section>
			<section>
				<h2>Generate the JWT like so</h2>
				<pre>
					<code data-noescape data-trim data-line-numbers="4-5|9-12|13|14|16-17">
public string GenerateJwtToken(User user)
{
	// generate token that is valid for 15 minutes
	var tokenHandler = new JwtSecurityTokenHandler();
	var key = Encoding.ASCII.GetBytes(_appSettings.Secret);

	var tokenDescriptor = new SecurityTokenDescriptor
	{
		Subject = new ClaimsIdentity(new[] { 
			new Claim("id", user.Id.ToString()), 
			new Claim("firstName", user.FirstName) 
		}),
		Expires = DateTime.UtcNow.AddMinutes(1),
		SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature)
	};
	var token = tokenHandler.CreateToken(tokenDescriptor);
	return tokenHandler.WriteToken(token);
}
					</code>
				</pre>
			</section>
			<section>
				<h2>The JWT is then returned</h2>
				<p>The return looks like the below</p>
				<img data-src="./media/login-response.png" />
			</section>
			<section>
				<h2>We can now see what's in it!</h2>
				<img data-src="./media/decoded-jwt.png" />
			</section>
		</section>

		<section>
			<section>
				<h2>Now we can provide the JWT with our requests to the API</h2>
				<p>The JWT is attached to requests via the Authorization header.</p>				
			</section>
			<section>
				<h2>The 'protected' route without the JWT</h2>
				<img data-src="./media/end-points/get-user-response.png" />				
			</section>
			<section>
				<h2>The 'protected' route with the JWT</h2>
				<img data-src="./media/protected-route-with-token.png" />				
			</section>
			<section>
				<h2>How does the API 'intercept' requests to the Authorised routes</h2>
				<pre>
					<code data-noescape data-trim data-line-numbers="3-4|5-11">
public async Task Invoke(HttpContext context, IUserService userService, IJwtUtils jwtUtils)
{
	var token = context.Request.Headers["Authorization"]
		.FirstOrDefault()?.Split(" ").Last();
	var userId = jwtUtils.ValidateJwtToken(token);
	if (userId != null)
	{
		// attach user to context on successful jwt validation
		context.Items["User"] = await userService
			.GetByIdAsync(userId.Value);
	}

	await _next(context);
}
					</code>
				</pre>
				<aside class="notes">
					<p>Custom middleware gets the Request. Takes the JWT from the Authorization header and then is able to extract the user id.</p>
					<p>The user id is then used to find a user and then attach it to the Http Context</p>
				</aside>
			</section>
			<section>
				<h2>The Authorize attribute</h2>
				<pre> 
					<code data-noescape data-trim data-line-numbers="3-6|8-11">
public void OnAuthorization(AuthorizationFilterContext context)
{
	// skip authorization if action is decorated with [AllowAnonymous] attribute
	var allowAnonymous = context.ActionDescriptor.EndpointMetadata.OfType<AllowAnonymousAttribute>().Any();
	if (allowAnonymous)
		return;

	// authorization. This is set via the custom middleware.
	var user = (User)context.HttpContext.Items["User"];
	if (user == null)
		context.Result = new JsonResult(new { message = "Unauthorized" }) { StatusCode = StatusCodes.Status401Unauthorized };
}
					</code>
				</pre>
			</section>
			<section>

			</section>
		</section>
      </div>
    </div>

    <script src="dist/reveal.js"></script>
    <script src="plugin/notes/notes.js"></script>
    <script src="plugin/markdown/markdown.js"></script>
    <script src="plugin/highlight/highlight.js"></script>
    <script>
      // More info about initialization & config:
      // - https://revealjs.com/initialization/
      // - https://revealjs.com/config/
      Reveal.initialize({
        hash: true,

        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [RevealMarkdown, RevealHighlight, RevealNotes],
      });
    </script>
  </body>
</html>
